:javascript
  (function() {
    var onloadPicture = function(file) {
      return function(event) {
      var infoColumn = createCardInfoColumn()
      var pictureColumn = createCardPictureColumn(file, event)
        $('.assay > .upload-new-file').append(
          $('<div>', { class: 'file-uploaded' })
          .append(
            $('<div>', { class: 'card-container new-file' })
            .append(infoColumn)
            .append(pictureColumn)
            .append(
              $('<input>', {
                type: 'hidden',
                name: 'sample[new_assays][]'
              })
            )
          )
        );

        // render Tooltip and Add-assays action
        updateAddAssaysControls();
      }
    }

    // Click on Add Assays
    $('#add-assays').on('click', function(e) {
      event.preventDefault();
      $('#sample_new_assays').click();
    });

    // Drag Picture to an input file and preview it
    $('#sample_new_assays').on('change', function(e) {
      removeFilesPreview();

      var files = e.target.files;

      for(var i = 0; i < files.length; i++) {
        var file = files[i];

        var reader = new FileReader();
        reader.onload = onloadPicture(file);
        reader.readAsDataURL(file);
      }

      if (files.length > 0) {
        // toggle buttons
        $('#undo-added-assays').removeClass('nodisplay');
      }
    });

    // Change the class on the target zone when dragging a file over it
    $(".clear-label > input[type='checkbox']").on('click', function(e) {
      $(this).closest('.file-uploaded').addClass('remove');
    });

    $('.assay > .upload-new-file').on('scroll', function(e) {
      var scrollDiff = $(this).scrollTop();
      // move dropzone-input into view
      $('.upload-picture').css('top', scrollDiff);
    });

    // Reset
    $('#undo-added-assays').on('click', function(e) {
      event.preventDefault();

      removeFilesPreview();

      // toggle buttons
      $('#undo-added-assays').addClass('nodisplay');

      // render Tooltip and Add-assays action
      updateAddAssaysControls();

      // remove files from input FileList
      var emptyClonedInput = $('#sample_new_assays').val('').clone(true);
      $('#sample_new_assays')
        .replaceWith(emptyClonedInput);
    });

    // initial state for Tooltip and Add-assays action
    updateAddAssaysControls();
  })();

   $(document).on('blur','.loinc_input',function(e){
     var hiddenInput = e.currentTarget.parentElement.parentElement.parentElement.children[2]
     hiddenInput.value = JSON.stringify({loinc_code: e.target.value})
   });

  $(document).on('blur','.result_input',function(e){
      var hiddenInput = e.currentTarget.parentElement.parentElement.parentElement.children[2]
      hiddenInput.value = JSON.stringify($.extend(JSON.parse(hiddenInput.value), {result: e.target.value}))
   });

  document.addEventListener("dragenter", function( event ) {
    if ( event.target.className == "upload-picture" ) {
      $('.choose-picture').addClass('on');
    }

  }, false);

  document.addEventListener("dragleave", function( event ) {
    if ( event.target.className == "upload-picture" ) {
      $('.choose-picture').removeClass('on');
    }
  }, false);

  function removeFilesPreview() {
    // remove all new-files preview
    $('.new-file').remove();
  }

  function fileThumbnail(file, url) {
    if (file.type.startsWith('image/')) {
      return $('<img>', { class: 'uploaded', src: url });
    } else {
      return $('<div>', { class: 'any-filetype icon-document' });
    }
  }

  function updateAddAssaysControls() {
    var assays = $('.assay-file');
    if (assays.length > 0) {
      $('.assay > .upload-new-file > .tooltip').addClass('nodisplay');
      $('#add-assays').removeClass('nodisplay');
    } else {
      $('.assay > .upload-new-file > .tooltip').removeClass('nodisplay');
      $('#add-assays').addClass('nodisplay');
    }
  }

  function createCardInfoColumn() {
    return $('<div>', { class: 'col' })
            .append(
              $('<div>', { class: 'row' })
              .append($('<div>', { class: 'col pe-2' }).append($('<label for="new_sample_assay_attachments_attributes">Loinc</label>')))
              .append($('<div>', { class: 'col' }).append($('<input class="loinc_input" type=text>')))
            )
            .append(
              $('<div>', { class: 'row' })
              .append($('<div>', { class: 'col pe-2' }).append($('<label for="new_sample_assay_attachments_attributes">Result</label>')))
              .append($('<div>', { class: 'col' }).append($('<input class="result_input" type=text>')))
            )
  }

  function createCardPictureColumn(file, event) {
    return $('<div>', { class: 'col pe-3' })
            .append(
              $('<div>', { class: 'picture-container assay-file'})
              .append(fileThumbnail(file, event.target.result))
              .append($('<div>', { class: 'picture-title', title: file.name })
              .append($('<div>').text(file.name)))
            )
  }